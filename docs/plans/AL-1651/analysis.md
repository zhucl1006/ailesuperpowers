# [AileApp] 任务聊天室解散功能（AL-1651）分析与计划书

> Jira Story: AL-1651
> 创建日期: 2026-02-13
> 开发负责人: Codex（联调代执行）

---

## 1. 需求理解与分析

### 目标

在任务聊天室 Header 下沉面板增加“解散聊天室”能力，仅当关联任务 businessStatus == Complete 时可执行。

### 关键业务约束

- 权限：聊天室成员可执行解散。
- 状态门禁：businessStatus != Complete 必须阻断。
- 数据落库：聊天室 status 更新为 Delete。
- 幂等：并发点击只生效一次。

### 风险与隐含需求

- “禁止查看详细资料”的接口边界需 PM/后端明确。
- 多端同步时，解散态与本地缓存一致性需确认。
- 文案与状态枚举需前后端统一（Delete/归档/已解散）。

## 2. UI 设计（如适用）

本 Story 涉及 UI 交互变更。

- 当前产物：文本交互说明（用于 G2 预审）
- 必补产物：进入开发前补齐 docs/plans/AL-1651/design.pencil，或由 PM 明确“复用现有布局，无新增视觉稿”

交互流程：
1. 进入聊天室，点击 Header 下沉面板。
2. 点击“解散聊天室”。
3. 若 businessStatus != Complete：提示“任务未完成，无法解散”。
4. 若 businessStatus == Complete：弹二次确认。
5. 确认后提交解散请求，聊天室进入只读归档态。

状态设计：
- 正常态：按钮可见。
- 阻断态：提示不可解散原因。
- 成功态：输入框隐藏/禁用，展示“该聊天室已解散”。
- 异常态：请求失败时保留当前态并给出重试提示。

## 3. 任务拆解

| 序号 | 任务名称 | 描述 | 依赖 | 预估复杂度 |
|------|----------|------|------|------------|
| T1 | 失败用例（RED） | 补充 businessStatus!=Complete 阻断测试与文案断言 | — | 低 |
| T2 | 状态门禁实现（GREEN） | 前端按钮点击校验 + 后端接口前置校验 | T1 | 中 |
| T3 | 解散确认与幂等 | 二次确认弹窗、并发去重/幂等兜底 | T2 | 中 |
| T4 | 解散态渲染 | 输入框禁用/隐藏、历史消息只读、提示文案 | T2 | 中 |
| T5 | 回归与重构（REFACTOR） | 整理状态枚举、公共文案、补齐边界用例 | T1-T4 | 低 |

## 4. 接口与数据流设计

- 读取：聊天室详情（含任务 businessStatus、聊天室 status）
- 写入：解散接口将聊天室 status 置为 Delete
- 前端渲染：依据 status=Delete 切换为只读归档态
- 错误处理：
  - 业务校验失败：返回“任务未完成，无法解散”
  - 幂等冲突：返回已解散态，前端按成功态处理

## 5. 测试用例

| 编号 | 场景 | 类型 | 步骤 | 预期结果 |
|------|------|------|------|----------|
| TC01 | 未完成任务点击解散 | 核心 | 设置 businessStatus!=Complete，点击解散 | 阻断操作并提示错误文案 |
| TC02 | 已完成任务解散确认 | 核心 | 设置 businessStatus=Complete，点击解散并确认 | 调用解散接口一次，状态切为 Delete |
| TC03 | 解散后只读态 | 核心 | 聊天室状态为 Delete | 输入框禁用/隐藏，历史可读，新消息不可发 |
| TC04 | 并发重复解散 | 边界 | 并发触发解散请求 | 最终仅一次生效，界面稳定在解散态 |
| TC05 | 接口失败回退 | 异常 | 模拟服务端失败 | 保留原状态并展示可重试提示 |

## 6. 验收标准（细化后回写 Jira AC）

- [ ] AC1：businessStatus!=Complete 时，解散入口可点击但必须阻断并提示原因（TC01）
- [ ] AC2：businessStatus==Complete 时，确认后可解散且仅一次生效（TC02/TC04）
- [ ] AC3：解散后聊天室进入只读归档态，历史可读、新消息不可发（TC03）
- [ ] AC4：失败场景可恢复且不产生脏状态（TC05）

## 7. AI 执行指引

- 执行顺序：T1 -> T2 -> T3 -> T4 -> T5
- TDD 约束：每个任务先 RED，再 GREEN，最后 REFACTOR
- 关键约束：
  - 不新增无业务价值抽象（YAGNI）
  - 优先复用现有状态枚举与弹窗组件（DRY）
  - 失败文案与成功文案统一由常量管理（KISS）
- 人工 Gate：
  - G2：PM/QA 对交互与文案审查通过后进入开发
  - G3：Code Review 需覆盖幂等与边界用例

## 8. Jira 关联

- Story Key：AL-1651
- 当前状态：To be delivered（联调后已回置）
- 联调证据：
  - 已验证 jira_get_issue / jira_search / jira_transition_issue / jira_add_comment
  - 已在 Jira 留存联调评论（含状态流转记录与需求接入摘要）
