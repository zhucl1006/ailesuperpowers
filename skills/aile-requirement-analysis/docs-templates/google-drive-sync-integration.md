# Google Drive 同步规则（aile-requirement-analysis）

> 本文件放在 Skill 目录下，供运行环境无法访问项目根目录文档时直接读取。

## 1. 适用范围

- 仅用于 `aile-requirement-analysis`。
- 场景：按单个 Story 进行分析时，若判定“需要回补规格文件”，则回补并同步到云端。
- 同步原则：只同步本次分析实际回补且判定为规格文件的文档。

## 2. 产品识别与目录路由

- 先做产品归属分析判断（结合 Story 内容、项目文档、工程命名）。
- 判断为 Aile：
  - `公用云端硬碟/NewAile文件/02-功能規格/[工程名字]`
- 判断为 AiPool：
  - `公用云端硬碟/AiPool文件/02-功能規格/[工程名字]`
- 无法确定：必须先询问用户确认目标目录。

### 2.1 强制定位策略（避免写入“我的云端硬碟”）

- 禁止用全局名称搜索定位根目录。
- 必须从固定根目录 ID 开始定位：
  - Aile 根目录 ID：`1u2I7QtOQDzWnQAVgINZqQbLv0wOjvR_0`
  - AiPool 根目录 ID：`12nxdtruC9WtZlDRL58SCxb0BuWUSibqv`
- 必须基于父目录 ID 逐层定位/创建到 `02-功能規格/[工程名字]/{target-dir}`。
- 上传时必须显式指定目标目录 ID，禁止无父目录上传。
- 上传后必须校验文件父目录；不在目标目录 ID 下即判定失败并转人工补传。

### 2.2 操作约束（必须通过 Skill）

- 所有 Google Drive 的检索、建目录、重命名、上传、清理，必须通过 `google-drive` Skill 执行。
- 禁止自行编写脚本、直接调用 Drive API、或使用其他未约定方法操作云盘。

## 3. 工程名字规则

- `[工程名字]` 默认取当前工作目录名。
- 若用户明确指定工程名，优先使用用户输入。

## 4. 规格回补判定与同步范围

### 4.1 必须先做“是否需要回补规格文件”判断

对当前 Story 的 `analysis.md` 输出中，必须给出：
- `是否需要回补规格文件：是/否`
- `回补文件清单`（若为“是”，列出目标文件与原因）

### 4.2 候选范围

- 默认候选：`docs/**/*.md`
- 明确排除：`docs/plans/**`（执行计划与过程记录不上传）

### 4.3 规格文件判定

候选文件仅在判定为“规格文件”时才允许同步。  
判定依据（满足其一）：
- 产品需求、架构设计、模块职责、API 契约、数据库结构、工程规范、测试规范
- 内容可作为实现/评审/验收依据

### 4.4 同步落位规则

- 已知目录（优先）：
  - `docs/specs/**/*.md` -> `.../[工程名字]/specs`
  - `docs/modules/**/*.md` -> `.../[工程名字]/modules`
  - `docs/guides/**/*.md` -> `.../[工程名字]/guides`
  - `docs/database/**/*.md` -> `.../[工程名字]/database`
  - `docs/api/**/*.md` -> `.../[工程名字]/api`
- `docs/` 下其他目录：
  - 若判定为规格文件，保留相对目录结构同步到 `.../[工程名字]/{relative-dir}`
  - 若判定为非规格文件，不同步

## 5. 上传与版本策略

1. 先查找同名文件。
2. 若同名文件存在，旧文件重命名为历史版本（建议后缀：`.history-YYYYMMDD-HHmmss`）。
3. 上传新文件（保留原文件名）。
4. 历史版本仅保留最近 5 个，超出部分删除。

约束：
- 只清理历史文件，不删除当前最新文件。
- 不允许直接覆盖导致历史丢失。

## 6. 失败兜底

若调用 `google-drive` Skill 失败或权限不足：

1. 明确输出失败原因。
2. 提示用户确认 `google-drive` Skill 登录账号是否正确，并检查共享盘访问权限。
3. 降级为“本地文档已更新 + 人工补传待办”，不得声称已上传成功。
