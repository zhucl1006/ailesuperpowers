# 阶段 2：分析报告（analysis.md）示例

> 目标：产出 `docs/plans/{Story-Key}/analysis.md`，作为阶段 2 输入与 AI 执行入口。

> Jira Story: AILE-142
> 创建日期: 2026-02-25
> 分析负责人: Zhang San

---

## 使用说明

- 本文件仅用于**分析报告**，不包含排期、任务状态跟踪、执行日志。
- 所有 AC 与测试用例可直接用于 QA 验收与回归。

---

## 1. 需求理解与分析

### 1.1 需求理解摘要

- 业务目标：为 Web 端新增“邮箱验证码登录”，降低密码登录失败导致的流失。
- 用户价值：用户忘记密码时可通过验证码快速登录，缩短登录耗时。
- 成功标准：验证码登录成功率 >= 95%，上线后 2 周内登录失败率下降 20%。

### 1.2 范围界定

- In Scope：登录页新增“验证码登录”入口、发送验证码、验证码校验、失败提示、风控限流。
- Out of Scope：注册流程改造、短信验证码、账号绑定流程。

### 1.3 影响与依赖

- 涉及模块/系统：`web-auth` 前端、`auth-service`、邮件网关服务。
- 上下游依赖：依赖邮件模板发布与风控策略开关配置。
- 对现有能力的影响：原密码登录不变；新增登录方式后需更新埋点口径。

---

## 2. UI 设计（如适用）

- 是否涉及 UI 变更：是
- 设计输入：`docs/plans/AILE-142/design.pencil`

### 2.1 用户路径/核心交互

| 步骤 | 用户动作 | 系统反馈 | 备注 |
|------|----------|----------|------|
| 1 | 进入登录页，切换到“验证码登录” | 展示邮箱输入框、验证码输入框、发送按钮 | 默认展示协议勾选状态 |
| 2 | 输入合法邮箱并点击“发送验证码” | 按钮进入 60s 倒计时，提示“验证码已发送” | 60s 内不可重复发送 |
| 3 | 输入 6 位验证码并点击“登录” | 登录成功后跳转工作台 | 同步写入登录成功埋点 |
| 4 | 输入错误验证码 | 提示“验证码错误，请重试” | 连续失败触发风控 |

### 2.2 页面与状态设计

- 页面结构：登录方式 Tab + 表单区 + 协议区 + 提交按钮。
- 状态覆盖：
  - 正常：可输入邮箱/验证码并提交。
  - 加载：发送验证码与登录按钮显示 loading，防重复提交。
  - 空状态：邮箱或验证码为空时按钮 disabled。
  - 错误状态：邮箱格式错误、验证码错误、验证码过期、服务不可用。

---

## 3. 验收条件（AC）初稿

> 将 Jira 业务表述改写为可测试条目（可观察、可验证、有边界）。

| AC 编号 | 业务表述（原文） | 可测试验收条件（改写后） | 验证方式 |
|--------|------------------|--------------------------|----------|
| AC-01 | 用户可通过邮箱验证码登录 | 在登录页切换到验证码登录后，输入合法邮箱并完成验证码校验，系统在 2 秒内完成登录并跳转工作台 | 手工测试 + 自动化 E2E |
| AC-02 | 验证码需控制发送频率 | 同一邮箱在 60 秒内最多发送 1 次验证码；超限时前端按钮 disabled 且后端返回限流错误码 | 接口测试 + 前端交互测试 |
| AC-03 | 错误场景需可感知 | 验证码错误/过期时页面展示明确错误文案，不得出现空白或通用报错 | 手工测试 |
| AC-04 | 不影响密码登录 | 原密码登录路径可正常登录，成功率不低于上线前基线 | 回归测试 + 监控对比 |

---

## 4. 测试用例

| 用例编号 | 关联 AC | 场景 | 前置条件 | 操作步骤 | 预期结果 |
|----------|---------|------|----------|----------|----------|
| TC-01 | AC-01 | 验证码登录成功 | 邮件网关可用、测试邮箱可收信 | 输入邮箱 -> 发送验证码 -> 输入正确验证码 -> 点击登录 | 2 秒内登录成功并跳转工作台 |
| TC-02 | AC-02 | 60 秒内重复发送 | 首次发送成功 | 60 秒内再次点击发送按钮 | 按钮不可点击，接口返回限流提示 |
| TC-03 | AC-03 | 验证码错误 | 已发送验证码 | 输入错误验证码并提交 | 提示“验证码错误，请重试”，不跳转 |
| TC-04 | AC-03 | 验证码过期 | 验证码已超过有效期 | 输入过期验证码并提交 | 提示“验证码已过期，请重新发送” |
| TC-05 | AC-04 | 密码登录回归 | 存在可用账号密码 | 使用密码登录流程 | 登录成功，原流程无行为变化 |

---

## 5. 隐含需求清单

> 重点补齐：权限、空状态、错误状态、性能、兼容性等。

| 类别 | 隐含需求 | 触发条件/边界 | 验证方式 |
|------|----------|---------------|----------|
| 权限 | 未勾选用户协议时禁止登录 | 协议勾选框为 false | UI 交互测试 |
| 空状态 | 邮箱或验证码为空时按钮不可用 | 任一字段为空 | UI 交互测试 |
| 错误状态 | 邮箱格式非法时即时提示 | 输入不符合 RFC 邮箱格式 | 单元测试 + 手工测试 |
| 性能 | 登录接口 P95 响应时间 < 800ms | 高峰期 200 RPS | 性能测试 |
| 兼容性 | 支持 Chrome/Edge/Safari 最新两个主版本 | 浏览器差异导致样式/事件异常 | 兼容性测试矩阵 |

---

## 6. 风险与待澄清项

| 优先级 | 问题/风险 | 影响 | 需要谁确认 | 截止时间 |
|--------|-----------|------|------------|----------|
| P1 | 邮件网关峰值吞吐是否覆盖活动流量 | 可能导致验证码延迟或丢失，影响登录成功率 | PM + 基础设施团队 | 2026-02-27 |
| P1 | 验证码有效期是否统一为 5 分钟 | AC 与实现口径不一致会导致验收争议 | PM + QA | 2026-02-26 |
| P2 | 风控阈值（连续失败次数）尚未最终确定 | 阈值过严影响转化，过松增加攻击风险 | 安全团队 | 2026-02-28 |

---

## 7. AI 执行指引

- 推荐执行顺序：
  1) 先补 AC 与测试（单元 + E2E）；
  2) 再实现发送/校验接口与前端交互；
  3) 最后做密码登录回归与埋点校验。
- 开发约束：遵循 KISS / YAGNI / DRY / SOLID，不新增无关抽象层。
- 质量门禁：严格 RED-GREEN-REFACTOR；无失败测试不得提交实现。
- 变更边界：仅改动 `web-auth`、`auth-service` 与对应测试目录。
- 人工介入点：出现 AC 冲突、依赖接口未就绪、风控策略不明确时立即暂停并 @PM/@QA。

---

## 8. Jira 关联

- Story Key：AILE-142
- Epic / 上级需求：AILE-EPIC-12（登录体验优化）
- 关联链接（PRD/SAD/设计稿/测试单）：
  - PRD: https://jira.example.com/browse/AILE-EPIC-12
  - 设计稿: https://jira.example.com/browse/AILE-142?focusedCommentId=design
  - 测试单: https://jira.example.com/browse/AILE-QA-77
- Jira Comment 回写内容摘要：已回写需求摘要、AC 草案、风险清单。
- 需同步的 Jira 字段：AC / 子任务 / 标签(`auth`,`email-login`) / 状态(`ANALYSIS_DONE`)
